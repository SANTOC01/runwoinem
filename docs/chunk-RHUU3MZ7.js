import{$b as k,Ba as g,Hb as x,Kb as D,M as m,Ob as p,Pa as f,Q as c,Qa as v,Rb as j,Ua as C,Va as b,Wa as y,Xa as E,_a as S,_b as L,ac as A,bc as T,c as o,j as s,na as u,nb as w,q as l}from"./chunk-YZXYK3LB.js";var _=class i extends L{constructor(e,a,t,n){super();this.http=e;this.platformId=a;this.lockService=t;this.toast=n;this.initializeData()}SHEET_URL=k.gipfelstuermerSheetUrl;CACHE_KEY="gipfelstuermer_data";CACHE_DURATION=5*60*1e3;config={id:"gipfelstuermer-2025",title:"Gipfelst\xFCrmer Event 2025",active:!1,metricLabel:"H\xF6henmeter",metricUnit:"HM",goalValue:1e5,maxEntryValue:1200,goals:[{target:1e4,emoji:"\u{1F3AD}",reward:"Trainer im Kost\xFCm"},{target:25e3,emoji:"\u{1F355}",reward:"Pizza nach dem Lauf"},{target:5e4,emoji:"\u{1F964}",reward:"Geheimsnack & Getr\xE4nke"},{target:75e3,emoji:"\u{1F370}",reward:"Erdbeertorte & Urkunden"},{target:1e5,emoji:"\u{1F483}",reward:"Schabernack!"}],chartProfile:[{x:0,y:0},{x:1e4,y:1e4},{x:12500,y:8e3},{x:25e3,y:25e3},{x:29e3,y:2e4},{x:5e4,y:5e4},{x:55e3,y:45e3},{x:75e3,y:75e3},{x:82e3,y:69e3},{x:1e5,y:1e5},{x:103e3,y:93e3},{x:11e4,y:7e4}],chartMaxScale:11e4};eventsSubject=new s([]);events$=this.eventsSubject.asObservable();entriesSubject=new s([]);rankingsSubject=new s([]);totalSubject=new s(0);chartDataSubject=new s({labels:[],values:[]});dataLoaded=!1;fetchedAt=null;entries$=this.entriesSubject.asObservable();rankings$=this.rankingsSubject.asObservable();total$=this.totalSubject.asObservable();chartData$=this.chartDataSubject.asObservable();initializeData(){return o(this,null,function*(){this.loadFromCache()||(yield this.refreshAllData())})}loadFromCache(){if(!p(this.platformId))return!1;try{let e=localStorage.getItem(this.CACHE_KEY);if(e){let{entries:a,events:t,timestamp:n}=JSON.parse(e);if(Date.now()-n<this.CACHE_DURATION)return this.updateState(a),this.eventsSubject.next(t),this.dataLoaded=!0,this.fetchedAt=n,!0;localStorage.removeItem(this.CACHE_KEY)}}catch(e){console.error("Error reading from cache:",e)}return!1}saveToCache(e,a){if(p(this.platformId))try{let t={entries:e,events:a,timestamp:Date.now()};localStorage.setItem(this.CACHE_KEY,JSON.stringify(t))}catch(t){console.error("Error saving to cache:",t)}}refreshAllData(){return o(this,null,function*(){try{let e=yield l(this.http.get(`${this.SHEET_URL}?action=getAll&challenge=HM1`)),a=this.processEntries(e?.main??[]),t=e?.events??[];this.updateState(a),this.eventsSubject.next(t),this.saveToCache(a,t),this.dataLoaded=!0,this.fetchedAt=Date.now()}catch(e){console.error("Error refreshing all data:",e),this.toast.show("Fehler beim Laden der Daten!",4e3)}})}loadData(){return o(this,null,function*(){this.dataLoaded||(yield this.refreshAllData())})}isFreshlyLoaded(e=3e4){return this.fetchedAt!==null&&Date.now()-this.fetchedAt<e}submitData(e,a){return o(this,null,function*(){if(!this.config.active){this.toast.show("Die Challenge ist beendet. Keine Eintr\xE4ge mehr m\xF6glich. \u{1F512}");return}if(!(yield this.lockService.requestUnlock()))return;let n={name:e,value:a,date:new Date().toISOString()};try{this.updateLocalState(n,"add"),yield l(this.http.get(`${this.SHEET_URL}?action=add&name=${encodeURIComponent(e)}&hohenmeter=${a}&challenge=HM1`)),this.toast.show("Eintrag erfolgreich hinzugef\xFCgt!")}catch(r){throw console.error("Error submitting data:",r),yield this.refreshAllData(),this.toast.show("Fehler beim Hinzuf\xFCgen des Eintrags!",4e3),r}})}deleteData(e){return o(this,null,function*(){if(yield this.lockService.requestUnlock())try{this.updateLocalState(e,"delete"),yield l(this.http.get(`${this.SHEET_URL}?action=delete&name=${encodeURIComponent(e.name)}&hohenmeter=${e.value}&challenge=HM1`)),this.toast.show("Eintrag gel\xF6scht.")}catch(t){throw console.error("Error deleting data:",t),yield this.refreshAllData(),this.toast.show("Fehler beim L\xF6schen des Eintrags!",4e3),t}})}addParticipant(e,a){return o(this,null,function*(){try{if((yield l(this.http.get(`${this.SHEET_URL}?action=addParticipant&eventName=${encodeURIComponent(e)}&participantName=${encodeURIComponent(a)}`)))?.status==="participant_added"){let n=[...this.eventsSubject.value],r=n.find(h=>h.name===e);return r&&(r.participants||(r.participants=[]),r.participants.push(a),this.eventsSubject.next(n),this.saveToCache(this.entriesSubject.value,n)),this.toast.show("Teilnehmer hinzugef\xFCgt!"),!0}return this.toast.show("Teilnehmer konnte nicht hinzugef\xFCgt werden.",4e3),!1}catch(t){return console.error("Error adding participant:",t),this.toast.show("Fehler beim Hinzuf\xFCgen des Teilnehmers!",4e3),!1}})}updateLocalState(e,a){let t=[...this.entriesSubject.value],n=!1;if(a==="add")t.unshift(e),n=!0;else{let r=t.findIndex(h=>h.name===e.name&&h.value===e.value);r!==-1&&(t.splice(r,1),n=!0)}n&&(this.updateState(t),this.saveToCache(t,this.eventsSubject.value))}updateState(e){this.entriesSubject.next(e),this.rankingsSubject.next(this.calculateRankings(e)),this.totalSubject.next(this.calculateTotal(e)),this.chartDataSubject.next(this.calculateChartData(e)),this.dataLoaded=!0}processEntries(e){return e.map(a=>{let t=a;return{name:t[0],value:parseInt(t[1]),date:t[2]}})}calculateTotal(e){return e.reduce((a,t)=>a+t.value,0)}calculateRankings(e){let a=e.reduce((t,n)=>(t[n.name]=(t[n.name]??0)+n.value,t),{});return Object.entries(a).map(([t,n])=>({name:t,value:n})).sort((t,n)=>n.value-t.value)}calculateChartData(e){let a=[...e].sort((t,n)=>new Date(t.date).getTime()-new Date(n.date).getTime()).slice(-100);return{labels:a.map(t=>new Date(t.date).toLocaleDateString()),values:a.map(t=>t.value)}}isDataLoaded(){return this.dataLoaded}static \u0275fac=function(a){return new(a||i)(c(j),c(u),c(A),c(T))};static \u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})};var R=i=>({"loading-overlay":i});function H(i,d){if(i&1&&(b(0,"div",0)(1,"div",1),E(2,"img",2),y()()),i&2){let e=S();C("ngClass",w(1,R,e.useOverlay))}}var I=class i{isLoading=!1;useOverlay=!0;static \u0275fac=function(e){return new(e||i)};static \u0275cmp=g({type:i,selectors:[["app-loading"]],inputs:{isLoading:"isLoading",useOverlay:"useOverlay"},decls:1,vars:1,consts:[[3,"ngClass"],[1,"loading"],["src","/assets/loadingman.gif","alt","Loading..."]],template:function(e,a){e&1&&f(0,H,3,3,"div",0),e&2&&v(a.isLoading?0:-1)},dependencies:[D,x],styles:[".loading-overlay[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1000;display:flex;justify-content:center;align-items:center}.loading[_ngcontent-%COMP%]{background-color:#fffffff2;padding:3px;border-radius:100px;box-shadow:0 4px 10px #0003;overflow-x:hidden;position:relative;min-width:150px}.loading[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:150px;height:auto;position:relative;animation:_ngcontent-%COMP%_runman-move 2s linear infinite}@keyframes _ngcontent-%COMP%_runman-move{0%{left:0}to{left:calc(100% - 150px)}}"]})};export{_ as a,I as b};
