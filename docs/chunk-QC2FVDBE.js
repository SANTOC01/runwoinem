import{M as m,Ob as h,Q as s,Rb as g,ac as p,bc as v,c as i,cc as f,dc as C,j as o,na as u,q as l}from"./chunk-6XXALYC7.js";var E=class c extends p{constructor(e,a,t,r){super();this.http=e;this.platformId=a;this.lockService=t;this.toast=r;this.initializeData()}SHEET_URL=v.gipfelstuermerSheetUrl;CACHE_KEY="km_challenge_data";CHALLENGE_ID="KM1";CACHE_DURATION=5*60*1e3;config={id:"eurotrip-km-2025",title:"Eurotrip 50.000km Challenge",active:!0,metricLabel:"Kilometer",metricUnit:"km",goalValue:5e4,maxEntryValue:200,goals:[],chartProfile:[],chartMaxScale:0};entriesSubject=new o([]);rankingsSubject=new o([]);totalSubject=new o(0);chartDataSubject=new o({labels:[],values:[]});dataLoaded=!1;entries$=this.entriesSubject.asObservable();rankings$=this.rankingsSubject.asObservable();total$=this.totalSubject.asObservable();chartData$=this.chartDataSubject.asObservable();initializeData(){return i(this,null,function*(){this.loadFromCache()||(yield this.refreshAllData())})}loadFromCache(){if(!h(this.platformId))return!1;try{let e=localStorage.getItem(this.CACHE_KEY);if(e){let{entries:a,timestamp:t}=JSON.parse(e);if(Date.now()-t<this.CACHE_DURATION)return this.updateState(a),this.dataLoaded=!0,!0;localStorage.removeItem(this.CACHE_KEY)}}catch(e){console.error("Error reading from cache:",e)}return!1}saveToCache(e){if(h(this.platformId))try{let a={entries:e,timestamp:Date.now()};localStorage.setItem(this.CACHE_KEY,JSON.stringify(a))}catch(a){console.error("Error saving to cache:",a)}}refreshAllData(){return i(this,null,function*(){try{let e=yield l(this.http.get(`${this.SHEET_URL}?action=get&challenge=${this.CHALLENGE_ID}`)),a=this.processEntries(e?.main??[]);this.updateState(a),this.saveToCache(a),this.dataLoaded=!0}catch(e){console.error("Error refreshing KM data:",e),this.toast.show("Fehler beim Laden der Daten!",4e3)}})}loadData(){return i(this,null,function*(){this.dataLoaded||(yield this.refreshAllData())})}submitData(e,a){return i(this,null,function*(){if(!this.config.active){this.toast.show("Die Challenge ist beendet. Keine Eintr\xE4ge mehr m\xF6glich. \u{1F512}");return}if(!(yield this.lockService.requestUnlock()))return;let r={name:e,value:a,date:new Date().toISOString()};try{this.updateLocalState(r,"add"),yield l(this.http.get(`${this.SHEET_URL}?action=add&name=${encodeURIComponent(e)}&hohenmeter=${a}&challenge=${this.CHALLENGE_ID}`)),this.toast.show("Eintrag erfolgreich hinzugef\xFCgt!")}catch(n){throw console.error("Error submitting KM data:",n),yield this.refreshAllData(),this.toast.show("Fehler beim Hinzuf\xFCgen des Eintrags!",4e3),n}})}deleteData(e){return i(this,null,function*(){if(yield this.lockService.requestUnlock())try{this.updateLocalState(e,"delete"),yield l(this.http.get(`${this.SHEET_URL}?action=delete&name=${encodeURIComponent(e.name)}&hohenmeter=${e.value}&challenge=${this.CHALLENGE_ID}`)),this.toast.show("Eintrag gel\xF6scht.")}catch(t){throw console.error("Error deleting KM data:",t),yield this.refreshAllData(),this.toast.show("Fehler beim L\xF6schen des Eintrags!",4e3),t}})}updateLocalState(e,a){let t=[...this.entriesSubject.value],r=!1;if(a==="add")t.unshift(e),r=!0;else{let n=t.findIndex(d=>d.name===e.name&&d.value===e.value);n!==-1&&(t.splice(n,1),r=!0)}r&&(this.updateState(t),this.saveToCache(t))}updateState(e){this.entriesSubject.next(e),this.rankingsSubject.next(this.calculateRankings(e)),this.totalSubject.next(this.calculateTotal(e)),this.chartDataSubject.next(this.calculateChartData(e)),this.dataLoaded=!0}processEntries(e){return e.map(a=>{let t=a;return{name:t[0],value:parseInt(t[1]),date:t[2]}})}calculateTotal(e){return e.reduce((a,t)=>a+t.value,0)}calculateRankings(e){let a=e.reduce((t,r)=>(t[r.name]=(t[r.name]??0)+r.value,t),{});return Object.entries(a).map(([t,r])=>({name:t,value:r})).sort((t,r)=>r.value-t.value)}calculateChartData(e){let a=[...e].sort((t,r)=>new Date(t.date).getTime()-new Date(r.date).getTime()).slice(-100);return{labels:a.map(t=>new Date(t.date).toLocaleDateString()),values:a.map(t=>t.value)}}isDataLoaded(){return this.entriesSubject.value.length>0}static \u0275fac=function(a){return new(a||c)(s(g),s(u),s(f),s(C))};static \u0275prov=m({token:c,factory:c.\u0275fac,providedIn:"root"})};export{E as a};
